{% extends 'masterpage.html' %}

{% load staticfiles %}
{% load stringfilters %}

{% block content %}
{% include 'searchbar.html' %}

<section class="features-icons text-center">
    <div class="container">
        {% include 'politician/profile_basic.html' %}
        <hr />

        <div class="row">
            <div id="annual_expenses_graph" class="col-xs-12 col-sm-12 col-md-12 col-lg-12"></div>
        </div>
        <hr />

        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Código</th>
                            <th>Tipo</th>
                            <th>Fornecedor</th>
                            <th>Valor</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if expenses|length > 0 %}
                        {% for expense in expenses %}
                        <tr>
                            <td>{{ expense.document }}</td>
                            <td>{{ expense.number }}</td>
                            <td>{{ expense.type }}</td>
                            <td>{{ expense.provider }}</td>
                            <td>{{ expense.price }}</td>
                            <td>{{ expense.date|date:'d/m/Y' }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6">Nenhum resultado encontrado</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock %}


{% block static %}
<link href="{% static 'highcharts/css/highcharts.css' %}" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="{% static 'highcharts/highcharts.js' %}">
</script>
<script type="text/javascript">
    const EXPENSE_MONTH_REGEX = /[0-9]{4}\-(.*?){2}\-[0-9]{2}T(.*?)/

    const data = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

    const expenses = JSON.parse('{{ expenses|jsonify|safe }}');
    expenses.forEach(expense => {
        if (EXPENSE_MONTH_REGEX.test(expense.date)) {
            const month = parseInt(EXPENSE_MONTH_REGEX.exec(expense.date)[1])
            data[month - 1] += expense.price
        }
    });
    console.log(data)

    Highcharts.chart("annual_expenses_graph", {
        chart: {
            type: 'column'
        },

        title: {
            text: 'Gráfico de despesas'
        },

        xAxis: {
            categories: [
                'Jan',
                'Feb',
                'Mar',
                'Apr',
                'May',
                'Jun',
                'Jul',
                'Aug',
                'Sep',
                'Oct',
                'Nov',
                'Dec'
            ],
            crosshair: true
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Gastos em R$'
            }
        },

        tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                '<td style="padding:0"><b>R$ {point.y:.2f}</b></td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },

        series: [{
            name: 'Gastos',
            color: "red",
            data
        }],

        responsive: {
            rules: [{
                condition: {
                    maxWidth: "100%"
                },
                chartOptions: {
                    legend: {
                        layout: 'horizontal',
                        align: 'center',
                        verticalAlign: 'bottom'
                    }
                }
            }]
        }
    })
</script>
{% endblock %}